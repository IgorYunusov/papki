language: cpp
sudo: required
dist: trusty
osx_image: xcode7.3

#os:
#  - linux
#  - osx
#
#compiler:
#  - clang
#  - gcc


env:
  global:
  #encrypted HOMEBREW_GITHUB_ACCESS_TOKEN for publishing to homebrew-tap
  - secure: "YQlVfncCW615TkmdPIng/cP5BQnY7+rclhukOuvpYLoj6d3Swa2eo5N7VKDKFGOVZtEbQGiKBJS6shVVfwNCB8G+GFOuPuFttxIndqY99mD7zsqj+kXHbTuIH1kEf9NbNspzpdX3XgBUi1xfooFTcl3yo2MeHlIJHcE2XNig0aBj8+Krc0CQAZZjHIeh8a0jjl2PIGeOTYEpSZLPtU+IAbSv7QYtx4UWcfcy1tq1TC9olqLlMf2V2a3nwoZT8I7+Q5zra8XZyXncc0n3IveDw6rC/yKOc3Ebcr2+kTOF8u5my29SacOrZilDC+B0DLTIOahdQ/ggH1yV1jrz414lDKk/C2fjDapAWnWlQjAUjUj5s1ChO0Q7+qdZPKaJI19tdkRrObJuUbqmGiEZ51o+bomb96WFx/cAQ8h5CVy3bIXlWz0z30+PrgC9Y79BGVDDFvK9LVYUK/13IOpVHvhGjTePEicLR7QFJARMTpUapXh4sp1EIoHPdXr7YwuJkLloOiJ7keSVgbmpvhKtH8Bi08bdKPs1CgEvozE8T7B8hOXxWp+ZqOM2MTFROmD5JG9E5/5XospsEaH1vloJOWQBjduFnPqh+PHcfTulU9cSci+vtqHBzByZgNSKl4+ebIKir/GB52PtOuLx678jYuP1kUm1Cbyc5KeZK+C3s2SASbY="
  - PRORAB_GIT_USERNAME=igagis
  - PRORAB_GIT_ACCESS_TOKEN=$HOMEBREW_GITHUB_ACCESS_TOKEN
  - linuxDependencies="debhelper prorab doxygen libutki-dev"



matrix:
  include:
    - os: osx
      env: BUILD_NAME=macosx
      compiler: clang
    - os: osx
      env: BUILD_NAME=ios
      compiler: clang
    - os: linux
      env: BUILD_NAME=debian
      compiler: gcc
    - os: linux
      env: BUILD_NAME=raspberry_pi
      compiler: gcc
    - os: linux
      env: BUILD_NAME=clang
      compiler: clang


before_install:
- if [ "$BUILD_NAME" == "macosx" ]; then
    brew tap igagis/tap &&
    brew update > /dev/null &&
    brew install prorab libutki;
  fi
- if [ "$BUILD_NAME" == "ios" ]; then
    rvm use ruby-2.2.1 &&
    pod repo add --silent igagis https://$PRORAB_GIT_USERNAME:$PRORAB_GIT_ACCESS_TOKEN@github.com/igagis/cocoapods-repo.git &&
    pod install --project-directory=ios;
  fi
- if [ "$BUILD_NAME" == "debian" ]; then
    echo "deb http://dl.bintray.com/igagis/deb /" | sudo tee /etc/apt/sources.list.d/igagis.list > /dev/null &&
    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 379CE192D401AB61 &&
    sudo apt-get update -qq &&
    sudo apt-get install -qq sbuild prorab &&
    sudo sbuild-adduser $LOGNAME &&
    sudo sbuild-createchroot --include=gnupg,dirmngr,build-essential unstable /srv/chroot/deb-amd64 http://httpredir.debian.org/debian &&
    echo "deb [trusted=yes] http://dl.bintray.com/igagis/deb /" | sudo tee /srv/chroot/deb-amd64/etc/apt/sources.list.d/igagis.list > /dev/null &&
    sudo chroot /srv/chroot/deb-amd64 apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 379CE192D401AB61;
  fi
- if [ "$BUILD_NAME" == "raspberry_pi" ]; then
    echo "deb http://dl.bintray.com/igagis/deb /" | sudo tee /etc/apt/sources.list.d/igagis.list > /dev/null &&
    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 379CE192D401AB61 &&
    sudo apt-get update -qq &&
    sudo apt-get install -qq prorab;
    sudo prorab-make-raspberry-chroot.sh /tmp/rasp &&
    echo "deb http://dl.bintray.com/igagis/rasp /" | sudo tee /tmp/rasp/etc/apt/sources.list.d/igagis.list > /dev/null &&
    sudo chroot /tmp/rasp apt-get update &&
    sudo chroot /tmp/rasp apt-get install --allow-unauthenticated -qq -y $linuxDependencies &&
    sudo mkdir -p /tmp/rasp/build &&
    sudo rsync -av $TRAVIS_BUILD_DIR/ /tmp/rasp/build/;
  fi
- if [ "$BUILD_NAME" == "clang" ]; then
    echo "deb http://dl.bintray.com/igagis/deb /" | sudo tee /etc/apt/sources.list.d/igagis.list > /dev/null &&
    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 379CE192D401AB61 &&
    sudo apt-get update -qq &&
    sudo apt-get install -qq $linuxDependencies lintian;
  fi


script:
- if [ "$BUILD_NAME" == "debian" ]; then
    prorab-deb-prepare.sh &&
    sbuild --run-lintian;
  fi
- if [ "$BUILD_NAME" == "clang" ]; then
    prorab-deb-prepare.sh &&
    dpkg-buildpackage -uc -us;
  fi
- if [ "$BUILD_NAME" == "macosx" ]; then
    make &&
    make test;
  fi
- if [ "$BUILD_NAME" == "ios" ]; then
    xcodebuild -workspace ios/tests.xcworkspace -scheme tests CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO;
  fi
- if [ "$BUILD_NAME" == "raspberry_pi" ]; then
    sudo chroot /tmp/rasp bash -c "cd /build && prorab-deb-prepare.sh" &&
    sudo chroot /tmp/rasp bash -c "cd /build && dpkg-buildpackage -us -uc";
  fi

before_deploy:
  - prorab-apply-version.sh -v `prorab-deb-version.sh debian/changelog` travis_bintray_*.json.in

deploy:
- provider: bintray
  skip_cleanup: true
  on:
    tags: true
    condition: $BUILD_NAME = debian
  file: travis_bintray_deb.json
  user: igagis
  key:
    secure: "Lar4sKMpCwHDA35DYmkAxAFcOMCaEb7pq4P7LoQnn7c9pxH5P3S6bZB0HOtJS8HjsJBb2iQfQf2nUp58SGJDQ3WeqX+b2OUHSQ0ySg9Akf7IWtpqA6HzpJC0otLCz3IqUo7kG9/tRTZkQZ53gqsVQjTA9nfFouwaNMDSezGGm2OJRg1ws9/fWlL2ib+/K55dbKTUUMsScpYSLcW6qoVux7q3Toy/iNdznASWha1ER7kXxQqD05UY6OZrFhPF1XoK/gLHD6ONtF9bMm9dfyk/IubwZ5Xj4ACp/7bK2tT3iEiAuNj31IKR+5uFl6jV9+Z+F6RVYq85fjm9VUqLfphlj12u4g08sWmK1as2elUk8Y/bNJuL6vLQnKywkQKDSKUrYiVxssyPOCNtxFKEmj1qUrAyKCeyVmgGYMFYwsRihCcccehoVVnTv0QfmKu0J2F876olHT8BzbXrlZWxnuD7117hUVGDuHWFI73wVF0gQ6ovq1lfVI8VFGtJG1QuS7kqb+3Gky5TC9j1dcASNWa8/pZwTz5if6d1pOQOqbVY4c1B/ZkBTDYAec/sHdxPlUbcHCPzc9r8ikbK0pl8Nfvpebf8q6xKUVe0iAwmhNXGWb8BD4V3IjdZCaIjVUYqV0ucJWD2oORABmJoZiDtiKcokgC72jU4bS76h5/mjTOMSlU="
  dry-run: false
- provider: bintray
  skip_cleanup: true
  on:
    tags: true
    condition: $BUILD_NAME = raspberry_pi
  file: travis_bintray_rasp.json
  user: igagis
  key:
    secure: "Lar4sKMpCwHDA35DYmkAxAFcOMCaEb7pq4P7LoQnn7c9pxH5P3S6bZB0HOtJS8HjsJBb2iQfQf2nUp58SGJDQ3WeqX+b2OUHSQ0ySg9Akf7IWtpqA6HzpJC0otLCz3IqUo7kG9/tRTZkQZ53gqsVQjTA9nfFouwaNMDSezGGm2OJRg1ws9/fWlL2ib+/K55dbKTUUMsScpYSLcW6qoVux7q3Toy/iNdznASWha1ER7kXxQqD05UY6OZrFhPF1XoK/gLHD6ONtF9bMm9dfyk/IubwZ5Xj4ACp/7bK2tT3iEiAuNj31IKR+5uFl6jV9+Z+F6RVYq85fjm9VUqLfphlj12u4g08sWmK1as2elUk8Y/bNJuL6vLQnKywkQKDSKUrYiVxssyPOCNtxFKEmj1qUrAyKCeyVmgGYMFYwsRihCcccehoVVnTv0QfmKu0J2F876olHT8BzbXrlZWxnuD7117hUVGDuHWFI73wVF0gQ6ovq1lfVI8VFGtJG1QuS7kqb+3Gky5TC9j1dcASNWa8/pZwTz5if6d1pOQOqbVY4c1B/ZkBTDYAec/sHdxPlUbcHCPzc9r8ikbK0pl8Nfvpebf8q6xKUVe0iAwmhNXGWb8BD4V3IjdZCaIjVUYqV0ucJWD2oORABmJoZiDtiKcokgC72jU4bS76h5/mjTOMSlU="
  dry-run: false
- provider: script
  skip_cleanup: true
  script: prorab-deploy-homebrew.sh igagis/tap
  on:
    tags: true
    condition: $BUILD_NAME = macosx
- provider: script
  skip_cleanup: true
  script: rvm 2.2.1 do prorab-deploy-cocoapods.sh igagis
  on:
    tags: true
    condition: $BUILD_NAME = ios
